var ptr_WriteConsoleW = Module.getExportByName(null,"WriteConsoleW");
var counter = 0;
var PROTECTION = 'wr-';
var examined_ranges_sizes = {};
var examined_ranges_data = {};
console.log("[frida] script loaded successfully!")
Interceptor.attach(ptr_WriteConsoleW,
{
	onEnter: function (args)
	{
		
		counter = counter + 1;
		if(counter == 8){
		console.log('counter:' + counter);
			let ranges = Process.enumerateRanges(PROTECTION);
			//console.log('[BEGIN] Memory ranges located: ' + ranges.length );
			ranges.forEach(function (range) {
				if (range.size){
				let destFileName = `dumps/${range.base}_dump`;
				let arrayBuffer = null;
				try {
					arrayBuffer = range.base.readByteArray(range.size);
					
					//console.log('[DEBUG] base: ' +  range.base + '| size: ' + range.size );
				}
				catch(e){
					console.log('[ERROR] Dumping memory at: ' + range.base);
				}
				

				if (arrayBuffer){
					let file = new File(destFileName, 'wb');
					file.write(arrayBuffer);
					file.flush();
					file.close();
								}
										}
				});
		//console.log('[END] Memory dumped correctly');
					
		}
			
		

	},

	onLeave: function (retvals)
	{
		
	}
});
